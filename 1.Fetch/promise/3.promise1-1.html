<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promiseのテスト</title>
</head>
<body>
<script>

/*3. Chapter.3 - Promiseのテスト

3.1. 基本的なテスト

  ES Promisesのメソッド等についてひととおり学ぶことができたため、 
  実際にPromiseを使った処理を書いていくことはできると思います。

  そうした時に、次にどうすればいいのか悩むのがPromiseのテストの書き方です。

  ここではまず、 Mochaを使った基本的なPromiseのテストの書き方について学んでいきましょう。

  また、この章でのテストコードはNode.js環境で実行することを前提としているため、 
  各自Node.js環境を用意してください。

  この書籍中に出てくるサンプルコードはそれぞれテストも書かれています。 
  
  テストコードは azu/promises-book から参照できます。

  3.1.1. Mochaとは

  Mochaの公式サイト: https://mochajs.org/

  ここでは、 Mocha自体については詳しく解説しませんが、 
  MochaはNode.js製のテストフレームワークツールです。

  MochaはBDD,TDD,exportsのどれかのスタイルを選択でき、
  テストに使うアサーションメソッドも任意のライブラリと組み合わせて利用します。 
  
  つまり、Mocha自体はテスト実行時の枠だけを提供しており、
  他は利用者が選択するというものになっています。

  Mochaを選択した理由は、以下のとおりです。

    ● 著名なテストフレームワークであること

    ● Node.jsとブラウザどちらのテストもサポートしている

    ● "Promiseのテスト"をサポートしている

  最後の "Promiseのテスト"をサポートしている
  とはどういうことなのかについては後ほど解説します。

  この章ではMochaを利用するため、
  npmを使いMochaをインストールしておく必要があります。

  $ npm install -g mocha

  また、アサーション自体はNode.jsに同梱されているassertモジュールを使用するので
  別途インストールは必要ありません。

  ※アサーションとは
    「アサーション（assertion）」とは、「自己主張という意味の単語で、
    相手と対等な立場に立って自己主張をするためのコミュニケーションスキルのことです。 
    相手の主張を否定したり、強い口調で無理に押し込めるのではなく、
    お互いの価値観を尊重しつつ、自分の意見を的確に言葉にするための方法です。

  まずはコールバックスタイルの非同期処理をテストしてみましょう。

  3.1.2. コールバックスタイルのテスト

  コールバックスタイルの非同期処理をテストする場合、
  Mochaでは以下のように書くことができます。*/

  // basic-test.js

  const assert = require("assert");

  it("should use `done` for test", (done) => {

      setTimeout(() => {

          assert(true);

          done(c);

      }, 0);
  });

  // このテストを basic-test.js というファイル名で作成し、 
  // 先ほどインストールしたMochaでコマンドラインからテストを実行することができます。

  // $ mocha basic-test.js

  // Mochaはitの仮引数にdone のように指定してあげると、 
  // done() が呼ばれるまでテストの終了を待つことで非同期のテストをサポートしています。

  // Mochaでの非同期テストは以下のような流れで実行されます。

  it("should use `done` for test", (done) => {

      setTimeout(() => {

          assert(true);

          done();

      }, 0);
  });

  // コールバックを使う非同期処理
  // done を呼ぶことでテストが終了する

  // よく見かける形の書き方ですね。

  /*実行結果:Google Chrome-console
      

  */  

</script>  
</body>
</html>